apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "5"
spec:
  project: default
  source:
    chart: immich
    repoURL: https://immich-app.github.io/immich-charts
    targetRevision: 0.10.1
    helm:
      releaseName: immich
      values: |
        controllers:
          main:
            containers:
              main:
                image:
                  tag: v2.0.0
                env:
                  REDIS_HOSTNAME: '{{ printf "%s-valkey" .Release.Name }}'
                  DB_HOSTNAME: "db-cluster-rw.cloudnative-pg.svc.cluster.local"
                  DB_USERNAME: "immich"
                  DB_DATABASE_NAME: "immich"
                  DB_PASSWORD:
                    valueFrom:
                      secretKeyRef:
                        name: immich-db-secret
                        key: password
                  IMMICH_MACHINE_LEARNING_URL: '{{ printf "http://%s-machine-learning:3003" .Release.Name }}'

        immich:
          metrics:
            enabled: true
          persistence:
            library:
              existingClaim: immich-library-pvc
        valkey:
          enabled: true
          persistence:
            data:
              enabled: true
              size: 2Gi
              storageClass: longhorn
        server:
          enabled: true
          controllers:
            main:
              containers:
                main:
                  image:
                    repository: ghcr.io/immich-app/immich-server
                    pullPolicy: IfNotPresent
          ingress:
            main:
              enabled: true
              annotations:
                # proxy-body-size is set to 0 to remove the body limit on file uploads
                nginx.ingress.kubernetes.io/proxy-body-size: "0"
                kubernetes.io/ingress.class: "nginx"
                nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
                cert-manager.io/cluster-issuer: "home-issuer"  
                nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
              hosts:
                - host: immich.rafa.home
                  paths:
                    - path: "/"
                      service:
                        identifier: main
              tls:
                - hosts:
                    - immich.rafa.home
                  secretName: immich-tls   
        machine-learning:
          enabled: true
          controllers:
            main:
              containers:
                main:
                  image:
                    repository: ghcr.io/immich-app/immich-machine-learning
                    pullPolicy: IfNotPresent
                  env:
                    TRANSFORMERS_CACHE: /cache
                    HF_XET_CACHE: /cache/huggingface-xet
                    MPLCONFIGDIR: /cache/matplotlib-config
          persistence:
            cache:
              enabled: true
              size: 3Gi
              type: emptyDir
              accessMode: ReadWriteMany
              # storageClass: longhorn
  destination:
    server: https://kubernetes.default.svc
    namespace: immich
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: immich-config
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  project: default
  source:
    repoURL: git@github.com:racela/home-server-argocd.git
    path: apps/config/immich
    targetRevision: HEAD
  destination:
    server: https://kubernetes.default.svc
    namespace: immich
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
